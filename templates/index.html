<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sonificación de Espectros Galácticos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        .container { max-width: 1100px; margin: 30px auto; background: #fff; padding: 24px 32px 32px 32px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .main-layout { display: flex; flex-direction: row; gap: 32px; }
        .form-col { flex: 1 1 340px; max-width: 370px; min-width: 260px; margin-right: 0; }
        .form-col form { margin-bottom: 0; }
        .form-col label { display: block; margin-top: 8px; font-weight: bold; }
        .form-col input[type="file"], .form-col input[type="number"], .form-col input[type="text"], .form-col select { width: 100%; padding: 6px; margin-top: 2px; border-radius: 4px; border: 1px solid #ccc; }
        .botones { display: flex; gap: 12px; margin-top: 16px; justify-content: center; }
        button, .descargar { padding: 8px 18px; border: none; border-radius: 4px; background: #1976d2; color: #fff; font-size: 1em; cursor: pointer; transition: background 0.2s; text-decoration: none; }
        button:hover, .descargar:hover { background: #125ea2; }
        .graph-col { flex: 2 1 0; min-width: 350px; display: flex; flex-direction: column; align-items: flex-start; }
        .svg-container { position: relative; margin: 0 0 18px 0; width: 100%; min-height: 440px; }
        .svg-container object { width: 100% !important; height: 440px !important; }
        .barra-reproduccion { position: absolute; top: 0; bottom: 0; width: 3px; background: #e53935; pointer-events: none; z-index: 10; }
        .audio-controls { margin-top: 0; display: flex; gap: 40px; justify-content: flex-start; }
        .audio-controls > div { display: flex; flex-direction: column; align-items: flex-start; }
        .audio-controls label { font-size: 0.95em; }
        .midi-player { display: flex; align-items: center; gap: 10px; margin: 18px 0 0 0; justify-content: flex-start; }
        .resultado { text-align: left; margin: 12px 0; color: #388e3c; font-weight: bold; }
        .descargas { display: flex; gap: 10px; justify-content: flex-start; margin-top: 12px; }
        @media (max-width: 900px) {
            .main-layout { flex-direction: column; gap: 0; }
            .form-col, .graph-col { max-width: 100%; min-width: 0; }
            .svg-container { min-height: 320px; }
        }
        @media (max-width: 600px) { .container { padding: 10px; } }
    </style>
</head>
<body>
<div class="container">
    <h1>Sonificación de Espectros Galácticos</h1>
    <div class="main-layout">
        <div class="form-col">
            <form method="post" enctype="multipart/form-data">
                <label for="archivo">Archivo de espectro (.txt):</label>
                <input type="file" name="archivo" id="archivo" {% if not session['archivo_path'] %}required{% endif %}>
                <label for="rango_ini">Rango inicial (Å):</label>
                <input type="number" name="rango_ini" id="rango_ini" value="{{ min_wavelength|default(6500) }}" min="{{ min_wavelength|default(6500) }}" max="{{ max_wavelength|default(6700) }}">
                <label for="rango_fin">Rango final (Å):</label>
                <input type="number" name="rango_fin" id="rango_fin" value="{{ max_wavelength|default(6700) }}" min="{{ min_wavelength|default(6500) }}" max="{{ max_wavelength|default(6700) }}">
                <label for="tempo">Tempo (BPM):</label>
                <input type="number" name="tempo" id="tempo" value="200">
                <label for="duracion">Duración de nota (s):</label>
                <input type="number" step="0.01" name="duracion" id="duracion" value="0.5">
                <label for="instrumento_emision">Instrumento Emisión (General MIDI):</label>
                <select name="instrumento_emision" id="instrumento_emision">
                    <option value="midi_crudo" selected>MIDI crudo</option>
                    <option value="24">Guitarra</option>
                    <option value="0">Piano</option>
                    <option value="40">Violín</option>
                    <option value="56">Trompeta</option>
                    <option value="73">Flauta</option>
                </select>
                <label for="instrumento_absorcion">Instrumento Absorción (General MIDI):</label>
                <select name="instrumento_absorcion" id="instrumento_absorcion">
                    <option value="midi_crudo" selected>MIDI crudo</option>
                    <option value="24">Guitarra</option>
                    <option value="0">Piano</option>
                    <option value="40">Violín</option>
                    <option value="56">Trompeta</option>
                    <option value="73">Flauta</option>
                </select>
                <label for="tipo_galaxia">Tipo de galaxia:</label>
                <select name="tipo_galaxia" id="tipo_galaxia" required>
                    <option value="Elíptica">Elíptica</option>
                    <option value="Espiral">Espiral</option>
                </select>
                <div class="botones">
                    <button type="submit">Sonificar</button>
                </div>
            </form>
            {% if resultado %}
                <div class="resultado">{{ resultado }}</div>
            {% endif %}
            {% if tipo_galaxia %}
                <div class="resultado">Tipo de galaxia detectado: <b>{{ tipo_galaxia }}</b></div>
            {% endif %}
            {% if archivo_emision or archivo_absorcion or archivo_completo %}
            <div class="descargas">
                {% if archivo_emision %}
                    <a class="descargar" href="{{ url_for('descargar', nombre_archivo=archivo_emision) }}" target="_blank">Descargar MIDI Emisión</a>
                {% endif %}
                {% if archivo_absorcion %}
                    <a class="descargar" href="{{ url_for('descargar', nombre_archivo=archivo_absorcion) }}" target="_blank">Descargar MIDI Absorción</a>
                {% endif %}
                {% if archivo_completo %}
                    <a class="descargar" href="{{ url_for('descargar', nombre_archivo=archivo_completo) }}" target="_blank">Descargar MIDI Completo</a>
                    <br>
                    <!-- Eliminado el reproductor de audio nativo para MIDI -->
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="graph-col">
            {% if archivo_emision or archivo_absorcion or archivo_completo %}
            <div class="svg-container">
                {% if resultado and not tipo_galaxia %}
                    <div class="resultado">{{ resultado }}</div>
                {% else %}
                    <object id="svgObject" type="image/svg+xml" data="{{ url_for('mostrar_svg') }}" width="100%" height="440"></object>
                    <div id="barra" class="barra-reproduccion" style="display:none;"></div>
                {% endif %}
            </div>
            <!-- Barra de selección de rango de sonificación -->
            <div id="region-slider-container" style="width:100%; margin: 10px 0 18px 0; display: flex; justify-content: center;">
                <div id="slider_rango" style="width: 90%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; width:100%; margin-bottom: 8px;">
                <span id="slider_ini_val">6500</span>
                <span id="slider_fin_val">6700</span>
            </div>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
            <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
            <script>
                // Slider doble usando noUiSlider
                const sliderRango = document.getElementById('slider_rango');
                const iniVal = document.getElementById('slider_ini_val');
                const finVal = document.getElementById('slider_fin_val');
                const rangoIniInput = document.getElementById('rango_ini');
                const rangoFinInput = document.getElementById('rango_fin');
                const minWavelength = parseInt('{{ min_wavelength|default(6500) }}');
                const maxWavelength = parseInt('{{ max_wavelength|default(6700) }}');
                // Destruir slider anterior si existe
                if (sliderRango.noUiSlider) {
                    sliderRango.noUiSlider.destroy();
                }
                noUiSlider.create(sliderRango, {
                    start: [parseInt(rangoIniInput.value), parseInt(rangoFinInput.value)],
                    connect: true,
                    step: 1,
                    range: {
                        'min': minWavelength,
                        'max': maxWavelength
                    },
                    format: {
                        to: function (value) { return Math.round(value); },
                        from: function (value) { return Number(value); }
                    }
                });
                sliderRango.noUiSlider.on('update', function(values, handle) {
                    iniVal.textContent = values[0];
                    finVal.textContent = values[1];
                    rangoIniInput.value = values[0];
                    rangoFinInput.value = values[1];
                });
                rangoIniInput.addEventListener('input', function() {
                    let ini = parseInt(rangoIniInput.value);
                    let fin = parseInt(rangoFinInput.value);
                    if(ini > fin) { ini = fin; rangoIniInput.value = ini; }
                    sliderRango.noUiSlider.set([ini, null]);
                });
                rangoFinInput.addEventListener('input', function() {
                    let ini = parseInt(rangoIniInput.value);
                    let fin = parseInt(rangoFinInput.value);
                    if(fin < ini) { fin = ini; rangoFinInput.value = fin; }
                    sliderRango.noUiSlider.set([null, fin]);
                });
                // Resetear los valores del slider y campos al cargar la página o tras sonificar
                document.addEventListener('DOMContentLoaded', function() {
                    rangoIniInput.value = minWavelength;
                    rangoFinInput.value = maxWavelength;
                    sliderRango.noUiSlider.set([minWavelength, maxWavelength]);
                    iniVal.textContent = minWavelength;
                    finVal.textContent = maxWavelength;
                });
            </script>
            <div class="audio-controls">
                <div>
                    <input type="range" id="vol_emision" min="0" max="1" step="0.01" value="1" style="width: 120px;">
                    <label for="vol_emision">Volumen Emisión</label>
                </div>
                <div>
                    <input type="range" id="vol_absorcion" min="0" max="1" step="0.01" value="1" style="width: 120px;">
                    <label for="vol_absorcion">Volumen Absorción</label>
                </div>
            </div>
            <div style="margin-top: 18px;">
                {% if archivo_completo %}
                <label style="font-weight: bold;">Reproducir Espectro Completo:</label>
                <!-- <audio id="audio_completo" controls style="margin-bottom: 8px;">
                    <source src="{{ url_for('descargar', nombre_archivo=archivo_completo) }}" type="audio/midi">
                    Tu navegador no soporta la reproducción de audio.
                </audio> -->
                <div style="color: #b71c1c; font-size: 0.95em; margin-bottom: 8px;">La reproducción directa de archivos MIDI no es soportada por la mayoría de los navegadores. Usa el reproductor MIDI de abajo.</div>
                {% endif %}
            </div>
            <div class="midi-player">
                <button id="playBtn" disabled>Reproducir MIDI</button>
                <select id="midiSelect">
                    {% if archivo_completo %}<option value="{{ url_for('descargar', nombre_archivo=archivo_completo) }}">Completo</option>{% endif %}
                </select>
            </div>
            {% endif %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <script>
    // --- Reproductor universal de MIDI ---
    async function reproducirMIDIUniversal(midiBuffer) {
        try {
            const midi = new Midi(midiBuffer);
            await Tone.start();
            const now = Tone.now();
            const synth = new Tone.PolySynth(Tone.Synth).toDestination();
            midi.tracks.forEach(track => {
                track.notes.forEach(note => {
                    synth.triggerAttackRelease(note.name, note.duration, now + note.time, note.velocity);
                });
            });
        } catch (e) {
            alert('No se pudo reproducir el MIDI en este navegador.');
        }
    }
    // --- Sobrescribir el evento de reproducción para usar el reproductor universal ---
    playBtn && playBtn.addEventListener('click', async () => {
        if (!midiBuffer) return;
        barra.style.display = 'block';
        const instEmision = instrumentoEmision ? instrumentoEmision.value : "midi_crudo";
        const instAbsorcion = instrumentoAbsorcion ? instrumentoAbsorcion.value : "midi_crudo";
        if(instEmision === "midi_crudo" || instAbsorcion === "midi_crudo"){
            await reproducirMIDIUniversal(midiBuffer);
            barra.style.display = 'none';
            return;
        }
        limpiarSynths();
        synths[0] = getSynthForInstrument(instEmision);
        synths[1] = getSynthForInstrument(instAbsorcion);
        setChannelVolume(0, channelVolumes[0]);
        setChannelVolume(1, channelVolumes[1]);
        let now = Tone.now();
        midiNotes.forEach(n => {
            synths[n.channel].triggerAttackRelease(n.note, n.duration, now + n.time);
        });
        if (barraAnim) cancelAnimationFrame(barraAnim);
        const svg = svgObject && svgObject.contentDocument && svgObject.contentDocument.documentElement;
        let svgWidth = svg ? svg.getBoundingClientRect().width : 600;
        let barraWidth = svgWidth;
        let barraElem = barra;
    });
    </script>
    </body>
    </html>